# -*- Mode: makefile-gmake -*-

EXE = test_core_plugins

TEST_PLUGIN_SRC_DIR = .
TEST_PLUGIN1_SRC = test_plugin1.c
TEST_PLUGIN2_SRC = test_plugin2.c

TEST_PLUGIN_BUILD_DIR = build
TEST_PLUGIN_DEBUG_BUILD_DIR = $(TEST_PLUGIN_BUILD_DIR)/debug
TEST_PLUGIN_RELEASE_BUILD_DIR = $(TEST_PLUGIN_BUILD_DIR)/release
TEST_PLUGIN_COVERAGE_BUILD_DIR = $(TEST_PLUGIN_BUILD_DIR)/coverage

TEST_PLUGIN1 = test_plugin1.so
TEST_PLUGIN1_DEBUG_LIB = $(TEST_PLUGIN_DEBUG_BUILD_DIR)/$(TEST_PLUGIN1)
TEST_PLUGIN1_RELEASE_LIB = $(TEST_PLUGIN_RELEASE_BUILD_DIR)/$(TEST_PLUGIN1)
TEST_PLUGIN1_COVERAGE_LIB = $(TEST_PLUGIN_COVERAGE_BUILD_DIR)/$(TEST_PLUGIN1)

TEST_PLUGIN2 = test_plugin2.so
TEST_PLUGIN2_DEBUG_LIB = $(TEST_PLUGIN_DEBUG_BUILD_DIR)/$(TEST_PLUGIN2)
TEST_PLUGIN2_RELEASE_LIB = $(TEST_PLUGIN_RELEASE_BUILD_DIR)/$(TEST_PLUGIN2)
TEST_PLUGIN2_COVERAGE_LIB = $(TEST_PLUGIN_COVERAGE_BUILD_DIR)/$(TEST_PLUGIN2)

TEST_PLUGIN1_DEBUG_OBJS = \
  $(TEST_PLUGIN1_SRC:%.c=$(TEST_PLUGIN_DEBUG_BUILD_DIR)/plugin_%.o)
TEST_PLUGIN1_RELEASE_OBJS = \
  $(TEST_PLUGIN1_SRC:%.c=$(TEST_PLUGIN_RELEASE_BUILD_DIR)/plugin_%.o)
TEST_PLUGIN1_COVERAGE_OBJS = \
  $(TEST_PLUGIN1_SRC:%.c=$(TEST_PLUGIN_COVERAGE_BUILD_DIR)/plugin_%.o)

TEST_PLUGIN2_DEBUG_OBJS = \
  $(TEST_PLUGIN2_SRC:%.c=$(TEST_PLUGIN_DEBUG_BUILD_DIR)/plugin_%.o)
TEST_PLUGIN2_RELEASE_OBJS = \
  $(TEST_PLUGIN2_SRC:%.c=$(TEST_PLUGIN_RELEASE_BUILD_DIR)/plugin_%.o)
TEST_PLUGIN2_COVERAGE_OBJS = \
  $(TEST_PLUGIN2_SRC:%.c=$(TEST_PLUGIN_COVERAGE_BUILD_DIR)/plugin_%.o)

TEST_PLUGIN_DEBUG_OBJS = \
  $(TEST_PLUGIN1_DEBUG_OBJS) \
  $(TEST_PLUGIN2_DEBUG_OBJS)
TEST_PLUGIN_RELEASE_OBJS = \
  $(TEST_PLUGIN1_RELEASE_OBJS) \
  $(TEST_PLUGIN2_RELEASE_OBJS)
TEST_PLUGIN_COVERAGE_OBJS = \
  $(TEST_PLUGIN1_COVERAGE_OBJS) \
  $(TEST_PLUGIN2_COVERAGE_OBJS)

$(TEST_PLUGIN_DEBUG_OBJS): | $(TEST_PLUGIN_DEBUG_BUILD_DIR)
$(TEST_PLUGIN_RELEASE_OBJS): | $(TEST_PLUGIN_RELEASE_BUILD_DIR)
$(TEST_PLUGIN_COVERAGE_OBJS): | $(TEST_PLUGIN_COVERAGE_BUILD_DIR)

TEST_PLUGIN_FLAGS = -fvisibility=hidden -DNFC_PLUGIN_EXTERNAL
EXTRA_EXE_LDFLAGS = -Wl,-export-dynamic

DEBUG_DEPS = $(TEST_PLUGIN1_DEBUG_LIB) $(TEST_PLUGIN2_DEBUG_LIB)
RELEASE_DEPS = $(TEST_PLUGIN1_RELEASE_LIB) $(TEST_PLUGIN2_RELEASE_LIB)
COVERAGE_DEPS = $(TEST_PLUGIN1_COVERAGE_LIB) $(TEST_PLUGIN2_COVERAGE_LIB)

DEPS = \
  $(TEST_PLUGIN_DEBUG_OBJS:%.o=%.d) \
  $(TEST_PLUGIN_RELEASE_OBJS:%.o=%.d) \
  $(TEST_PLUGIN_COVERAGE_OBJS:%.o=%.d)

include ../common/Makefile

$(DEBUG_BUILD_DIR)/plugin_%.o : $(TEST_PLUGIN_SRC_DIR)/%.c
	$(CC) -c $(DEBUG_CFLAGS) $(TEST_PLUGIN_FLAGS) -MT"$@" -MF"$(@:%.o=%.d)" $< -o $@

$(RELEASE_BUILD_DIR)/plugin_%.o : $(TEST_PLUGIN_SRC_DIR)/%.c
	$(CC) -c $(RELEASE_CFLAGS) $(TEST_PLUGIN_FLAGS) -MT"$@" -MF"$(@:%.o=%.d)" $< -o $@

$(COVERAGE_BUILD_DIR)/plugin_%.o : $(TEST_PLUGIN_SRC_DIR)/%.c
	$(CC) -c $(COVERAGE_CFLAGS) $(TEST_PLUGIN_FLAGS) -MT"$@" -MF"$(@:%.o=%.d)" $< -o $@

$(TEST_PLUGIN1_DEBUG_LIB): $(TEST_PLUGIN1_DEBUG_OBJS)
	$(LD) -shared $^ $(DEBUG_LDFLAGS) $(LIBS) -o $@

$(TEST_PLUGIN1_RELEASE_LIB): $(TEST_PLUGIN1_RELEASE_OBJS)
	$(LD) -shared $^ $(RELEASE_LDFLAGS) $(LIBS) -o $@

$(TEST_PLUGIN1_COVERAGE_LIB): $(TEST_PLUGIN1_COVERAGE_OBJS)
	$(LD) -shared $^ $(COVERAGE_LDFLAGS) $(LIBS) -o $@

$(TEST_PLUGIN2_DEBUG_LIB): $(TEST_PLUGIN2_DEBUG_OBJS)
	$(LD) -shared $^ $(DEBUG_LDFLAGS) $(LIBS) -o $@

$(TEST_PLUGIN2_RELEASE_LIB): $(TEST_PLUGIN2_RELEASE_OBJS)
	$(LD) -shared $^ $(RELEASE_LDFLAGS) $(LIBS) -o $@

$(TEST_PLUGIN2_COVERAGE_LIB): $(TEST_PLUGIN2_COVERAGE_OBJS)
	$(LD) -shared $^ $(COVERAGE_LDFLAGS) $(LIBS) -o $@
